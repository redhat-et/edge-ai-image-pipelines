name: "Build Ollama Server"
on:
  workflow_dispatch:
    inputs:
      base-reference:
        type: string
        required: false
        description: "Base bootc container reference (can be left blank)"
  workflow_call:
    inputs:
      base-reference:
        type: string
        required: false

jobs:
  base-reference:
    uses: ./.github/workflows/get-base-reference.yml
    secrets: inherit
    with:
      base-reference: ${{ inputs.base-reference }}

  build-ollama-container:
    uses: ./.github/workflows/build-rhel-bootc-image.yml
    secrets: inherit
    with:
      containerfile: ollama/Containerfile.ollama
      tag-list: "ollama-worker"
      dest-image: ${{ vars.ARTIFACT_REGISTRY_REPO }}
      dest-host: ${{ vars.ARTIFACT_REGISTRY_HOST }}
      build-args: |
        BASE_IMAGE=registry.access.redhat.com/ubi9/ubi:9.6

  build-ollama:
    uses: ./.github/workflows/build-rhel-bootc-image.yml
    secrets: inherit
    needs: [build-ollama-container, base-reference]
    with:
      containerfile: tegra/Containerfile.podman
      dest-image: "redhat-et/rhel-bootc-tegra"
      tag-list: "ollama"
      # In this case, DAT_IMAGES lists models from a Quay model saddle
      build-args: |
        BASE_IMAGE=${{ needs.base-reference.outputs.base-reference }}
        APP_IMAGES=${{ needs.build-ollama-container.outputs.dest-reference }}
        DAT_IMAGES=quay.io/ncao/modelsaddle-catalog:gemma3-4b quay.io/ncao/modelsaddle-catalog:gemma3-4b quay.io/ncao/modelsaddle-catalog:granite3.2-vision-2b

  build-ollama-raw:
    uses: ./.github/workflows/build-rhel-bootc-raw-image.yml
    secrets: inherit
    needs: build-ollama
    with:
      config-file: ./tegra/config.toml
      src-reference: ${{ needs.build-ollama.outputs.dest-reference }}
