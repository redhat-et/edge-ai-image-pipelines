name: "Build vLLM Server"
on:
  workflow_dispatch:
    inputs:
      models:
        type: string
        required: true
  
  workflow_call:
    inputs:
      models:
        type: string
        required: true

jobs:
  # vLLM with no models. Those are added in the next job
  build-vllm-base:
    uses: ./.github/workflows/build-rhel-bootc-image.yml
    secrets: inherit
    with:
      containerfile: tegra/Containerfile.podman
      dest-image: ${{ vars.ARTIFACT_REGISTRY_REPO }}
      dest-host: ${{ vars.ARTIFACT_REGISTRY_HOST }}
      tag-list: "vllm-base"
      build-args: |
        APP_IMAGES=quay.io/redhat-user-workloads/octo-edge-tenant/jetson-wheels-vllm-app@sha256:4d1ed330d00308a3148cdea4495be09a05cee9cf7a114eed0ca83e40e6d58794

  build-vllm:
    uses: ./.github/workflows/build-rhel-bootc-image.yml
    secrets: inherit
    needs: build-vllm-base
    with:
      containerfile: vllm/Containerfile.hf
      dest-image: ${{ vars.DEST_REGISTRY_REPO }}
      dest-host: ${{ vars.DEST_REGISTRY_HOST }}
      tag-list: "vllm"
      build-args: |
        BASE_IMAGE=${{ needs.build-vllm-base.outputs.dest-reference }}
        HF_REPOS=${{ inputs.models }}

  build-vllm-raw:
    uses: ./.github/workflows/build-rhel-bootc-raw-image.yml
    secrets: inherit
    needs: build-vllm
    with:
      config-file: ./tegra/config.toml
      src-reference: ${{ needs.build-vllm.outputs.dest-reference }}

